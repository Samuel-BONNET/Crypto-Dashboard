<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Graph - {{ token_id|capitalize }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            background-color: #f9fafb;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1000px;
            margin: 3rem auto;
            padding: 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .title {
            font-size: 1.8rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 1rem;
        }
        .back-btn {
            margin-bottom: 1rem;
        }
        .btn-group {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <a href="/" class="btn btn-outline-secondary back-btn">â¬… Retour au dashboard</a>
    <div class="title">ðŸ“Š {{ token_id|capitalize }} - Prix</div>

    <!-- Boutons pour changer la pÃ©riode -->
    <div class="btn-group mb-3">
        <button class="btn btn-sm btn-primary" onclick="loadHistory('15m')">15 min</button>
        <button class="btn btn-sm btn-primary" onclick="loadHistory('4h')">4 h</button>
        <button class="btn btn-sm btn-primary" onclick="loadHistory('7d')">7 j</button>
    </div>

    <canvas id="priceChart" height="120"></canvas>
</div>

<script>
let chart = null;

async function loadHistory(range) {
    let interval = "1m";
    let limit = 1440;

    if(range === "15m") { interval="1m"; limit=15; }
    if(range === "4h")  { interval="5m"; limit=48; }  // 48 bougies de 5m = 4h
    if(range === "7d")  { interval="1h"; limit=168; } // 168 bougies de 1h = 7j

    try {
        const res = await fetch(`/api/history/{{ token_id }}?interval=${interval}&limit=${limit}`);
        const data = await res.json();
        if(!data.prices) return;

        const labels = data.prices.map(item => {
            const date = new Date(item[0]);
            return (date.getMonth()+1) + "/" + date.getDate() + " " + date.getHours() + ":" + String(date.getMinutes()).padStart(2,"0");
        });
        const prices = data.prices.map(item => item[1]);

        if(chart) chart.destroy(); // supprimer ancien graphique
        renderChart(labels, prices);

    } catch(err) {
        console.error("Erreur de rÃ©cupÃ©ration des donnÃ©es :", err);
    }
}

function renderChart(labels, prices) {
    const ctx = document.getElementById("priceChart").getContext("2d");
    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Prix en USD",
                data: prices,
                borderColor: "#4F46E5",
                backgroundColor: "rgba(79,70,229,0.1)",
                fill: true,
                tension: 0.3,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    display: true,
                    ticks: { maxTicksLimit: 12 }
                },
                y: {
                    display: true,
                    beginAtZero: false
                }
            },
            plugins: {
                legend:{ display: true },
                tooltip: {
                    mode: "index",
                    intersect: false,
                    callbacks: {
                        label: (ctx) => "$" + ctx.raw.toFixed(2)
                    }
                }
            }
        }
    });
}

// Charger par dÃ©faut 15 min
loadHistory("15m");
</script>

</body>
</html>
