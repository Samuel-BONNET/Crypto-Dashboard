<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Graph - {{ token_id|capitalize }}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
body {
    background: linear-gradient(135deg, #0f172a, #1e293b);
    font-family: 'Segoe UI', Roboto, Arial, sans-serif;
    color: #f8fafc;
    margin: 0;
    padding: 2rem;
}
.container {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 2rem;
    background: rgba(30, 41, 59, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.6);
}
.title {
    font-size: 2rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 1.5rem;
    text-shadow: 0 2px 5px rgba(0,0,0,0.5);
}
.back-btn {
    display: inline-block;
    background: transparent;
    border: 1px solid #475569;
    color: #cbd5e1;
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease-in-out;
    margin-bottom: 1rem;
}
.back-btn:hover {
    background: rgba(71, 85, 105, 0.5);
    color: #f8fafc;
    transform: translateX(-3px);
}
.btn-group button {
    background-color: #3b82f6;
    border: none;
    transition: all 0.2s ease-in-out;
}
.btn-group button:hover {
    background-color: #2563eb;
    transform: scale(1.05);
    box-shadow: 0 4px 10px rgba(59,130,246,0.4);
}
canvas {
    background: rgba(15, 23, 42, 0.6);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
}
</style>
</head>
<body>

<div class="container">
    <a href="/" class="back-btn">â¬… Retour au dashboard</a>
    <div class="title">ðŸ“Š {{ token_id|capitalize }} - Prix</div>

    <div class="btn-group mb-3">
        <button class="btn btn-sm btn-primary" onclick="loadHistory('10m')">10 min</button>
        <button class="btn btn-sm btn-primary" onclick="loadHistory('4h')">4 h</button>
        <button class="btn btn-sm btn-primary" onclick="loadHistory('1d')">1 j</button>
    </div>

    <canvas id="priceChart" height="120"></canvas>
</div>

<script>
let chart = null;

async function loadHistory(range) {
    let interval = "1m";
    let bucketMs = 10*60*1000;
    let totalBuckets = 60;

    if(range==="10m") {
        interval="1m";
        bucketMs = 10*60*1000;
        totalBuckets = 60;
    }
    if(range==="4h") {
        interval="1h";          // rÃ©cupÃ©rer lâ€™historique par heure
        bucketMs = 4*60*60*1000;
        totalBuckets = 42;      // 42 bougies de 4h
    }
    if(range==="1d") {
        interval="1h";          // bougies dâ€™1h regroupÃ©es pour 1j
        bucketMs = 24*60*60*1000;
        totalBuckets = 30;      // 30 jours
    }

    const apiLimit = totalBuckets * (bucketMs / (interval==="1m"?60*1000:60*60*1000)) + 20;

    try {
        const res = await fetch(`/api/history/{{ token_id }}?interval=${interval}&limit=${Math.ceil(apiLimit)}`);
        const data = await res.json();
        if(!data.prices) return;

        const step = Math.floor(bucketMs / (interval==="1m"?60*1000:60*60*1000));
        const grouped = [];
        for(let i=0;i<data.prices.length;i+=step){
            const chunk = data.prices.slice(i,i+step);
            if(chunk.length===0) continue;
            const avg = chunk.reduce((acc,p)=>acc+p[1],0)/chunk.length;
            grouped.push([chunk[0][0], avg]);
        }

        const labels = grouped.map(p=>{
            const d = new Date(p[0]);
            if(range==="1d") return `${d.getDate()}/${d.getMonth()+1}`;
            if(range==="4h") return `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}h`;
            return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
        });
        const prices = grouped.map(p=>p[1]);

        if(chart) chart.destroy();
        const ctx = document.getElementById("priceChart").getContext("2d");
        chart = new Chart(ctx, {
            type:"line",
            data:{
                labels: labels,
                datasets:[{
                    label:"Prix en USD",
                    data: prices,
                    borderColor:"#3b82f6",
                    backgroundColor:"rgba(59,130,246,0.1)",
                    fill:true,
                    tension:0.35,
                    pointRadius:0
                }]
            },
            options:{
                responsive:true,
                scales:{
                    x:{ ticks:{ color:"#cbd5e1" }, grid:{ color:"rgba(148,163,184,0.1)" } },
                    y:{ ticks:{ color:"#cbd5e1" }, grid:{ color:"rgba(148,163,184,0.1)" }, beginAtZero:false }
                },
                plugins:{
                    legend:{ labels:{ color:"#f8fafc" } },
                    tooltip:{ callbacks:{ label: ctx=>"$"+ctx.raw.toFixed(2) } }
                }
            }
        });

    } catch(e){ console.error(e); }
}

loadHistory("10m");
</script>

</body>
</html>
